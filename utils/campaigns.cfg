#textdomain wesnoth-Non_Fatal_Wounds

# This file contains special handling for campaigns.
#
# Using so many ifdefs is an odd style, but if they weren't there then each of these would still need a comment saying which campaign it refers to, and it might affect other campaigns too.

## filter special characters

[event]
    name=prestart
    {CLEAR_VARIABLE nfw_exclude_unit_id}
[/event]

#ifdef CAMPAIGN_DELFADORS_MEMOIRS
[event]
    name=prestart
    {VARIABLE nfw_exclude_unit_id "Methor"}
[/event]
#endif

#ifdef CAMPAIGN_NORTHERN_REBIRTH
[event]
    name=prestart
    # The white mages are revived by the campaign code
    {VARIABLE nfw_exclude_unit_id "Sister Thera,Father Morvin"}
[/event]

## TODO Liches on Northern Rebirth
[event]
    name=last_breath
    id=nfw_malifor_filter
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 05a_01_The_Pursuit}
    [/filter_condition]
    [filter]
        id=Malifor
    [/filter]
    {VARIABLE nfw_already_wound yes}
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Dissolution" {NFW_COLOR_RED}}
[/event]

[event]
    name=last_breath
    id=nfw_RoSothian_filter
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 07a_Settling_Disputes}
    [/filter_condition]
    [filter]
        id="Ro'Sothian","Ro'Arthian"
    [/filter]
    {VARIABLE nfw_already_wound yes}
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Capture" color="100,255,100"}
[/event]

[event]
    name=attack_end
    id=nfw_white_mages_attacker
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL nfw_white_mages_wound equals yes}
    [/filter_condition]
    [filter]
        id=Sister Thera,Father Morvin
        formula=hitpoints < 1
    [/filter]
    {CLEAR_VARIABLE nfw_unit_type,nfw_second_unit_type,nfw_weapon_type,nfw_scary_weapon,nfw_scary_weapon_translated}
    {VARIABLE nfw_scary_weapon $second_weapon.name}
    {VARIABLE nfw_weapon_type $second_weapon.type}
    {VARIABLE nfw_scary_weapon_translated $second_weapon.description}
    [store_unit_type]
        type=$unit.type
        variable=nfw_unit_type
    [/store_unit_type]
    [store_unit_type]
        type=$second_unit.type
        variable=nfw_second_unit_type
    [/store_unit_type]
    [if]
        {NFW_wounds_DISABLED}
        [or]
            {NFW_wounds_DISABLED_with_plague}
        [/or]
        [then]
            {CLEAR_VARIABLE nfw_already_wound}
        [/then]
        [else]
            [fire_event]
                name=nfwe_rand_wound
                [primary_unit]
                    {EVENT_UNIT}
                [/primary_unit]
                [secondary_unit]
                    {EVENT_SECOND_UNIT}
                [/secondary_unit]
            [/fire_event]
        [/else]
    [/if]
[/event]

[event]
    name=attack_end
    id=nfw_white_mages_defender
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL nfw_white_mages_wound equals yes}
    [/filter_condition]
    [filter_second]
        id=Sister Thera,Father Morvin
        formula=$second_unit.hitpoints < 1
    [/filter_second]
    {CLEAR_VARIABLE nfw_unit_type,nfw_second_unit_type,nfw_weapon_type,nfw_scary_weapon,nfw_scary_weapon_translated}
    {VARIABLE nfw_scary_weapon $weapon.name}
    {VARIABLE nfw_weapon_type $weapon.type}
    {VARIABLE nfw_scary_weapon_translated $second_weapon.description}
    [store_unit_type]
        type=$unit.type
        variable=nfw_unit_type
    [/store_unit_type]
    [store_unit_type]
        type=$second_unit.type
        variable=nfw_second_unit_type
    [/store_unit_type]
    [if]
        {NFW_wounds_DISABLED}
        [or]
            {NFW_wounds_DISABLED_with_plague}
        [/or]
        [then]
            {CLEAR_VARIABLE nfw_already_wound}
        [/then]
        [else]
            [fire_event]
                name=nfwe_rand_wound
                [primary_unit]
                    {EVENT_SECOND_UNIT}
                [/primary_unit]
                [secondary_unit]
                    {EVENT_UNIT}
                [/secondary_unit]
            [/fire_event]
        [/else]
    [/if]
[/event]

[event]
    name=unit_placed
    id=nfw_white_mages_option
    first_time_only=yes
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 05a_01_The_Pursuit}
        [have_unit]
            id=Sister Thera,Father Morvin
            count=2
        [/have_unit]
    [/filter_condition]
    [message]
        speaker=narrator
        message=_ "<b><i>Non-Fatal Wounds:</i></b> Sister Thera and Father Morvin will revive each other indefinitely every time they lose all of their health. Choose if you want each time this happens to receive a wound like any other unit or not. The effects will be applied immediately, and they cannot receive capture, death, elemental, ghost, or undeath wounds."
        image="misc/nfw-icon.png"
        [option]
            label=_ "Allows them to get wounds"
            default=yes
            [command]
                {VARIABLE nfw_white_mages_wound yes}
            [/command]
        [/option]
        [option]
            label=_ "Don't let them get wounds"
            # no action, just leave the default behavior
        [/option]
    [/message]
[/event]
#endif

#ifdef CAMPAIGN_UNDER_THE_BURNING_SUNS
[event]
    name=prestart
    {VARIABLE nfw_exclude_unit_id "Garak"}
[/event]
#endif

[event]
    name=start

    [switch]
        variable=current_scenario_id
    [/switch]
[/event]

[event]
    name=start
    [switch]
        variable=current_scenario_id
        ## A list of scenarios where no units should survive, or the survivors don't reappear in later scenarios.
#ifdef CAMPAIGN_SCEPTRE_FIRE
        [case]
            value=7_Outriding_the_Outriders
            [message]
                speaker=narrator
                # po: generic message which could apply to any scenario where the storyline already explains why even the surviving units don't reappear later in the campaign
                message= _ "<b><i>Non-Fatal Wounds</i></b> modification is disabled for this scenario."
                image="misc/nfw-icon.png"
            [/message]
            [fire_event]
                name=nfw_disable_for_this_scenario
            [/fire_event]
            [set_variable]
                name=nfw_disabled
                value=yes
            [/set_variable]
        [/case]
#endif
#ifdef CAMPAIGN_THE_SOUTH_GUARD
        [case]
            value=07b_Pebbles_in_the_Flood
            [message]
                speaker=narrator
                message= _ "<b><i>Non-Fatal Wounds</i></b> modification is disabled for this scenario."
                image="misc/nfw-icon.png"
            [/message]
            [fire_event]
                name=nfw_disable_for_this_scenario
            [/fire_event]
            [set_variable]
                name=nfw_disabled
                value=yes
            [/set_variable]
        [/case]
#endif
        # Campaign-specific warning that display a message but don't change the behavior of the mod.
#ifdef CAMPAIGN_DELFADORS_MEMOIRS
        [case]
            # Using scenario 2 because the first scenario is just dialogue.
            value=02_This_Valley_Belongs_to_Me
            [message]
                speaker=narrator
                message= _ "<b><i>Non-Fatal Wounds</i></b> modification might work unusually with this campaign. The recall lists change during the campaign, and units that are non-fatally wounded may reappear on the wrong recall list."
                image="misc/nfw-icon.png"
                # I'm not worrying about campaigns like SotA, which have divergent paths but each path has similar recruit lists and the paths recombine later
            [/message]
        [/case]
#endif
        # Scenario-specific warnings with options to change the behavior of the mod.
#ifdef CAMPAIGN_THE_RISE_OF_WESNOTH
        [case]
            value=06_Temple_in_the_Deep
            [message]
                speaker=narrator
                message=_ "<b><i>Non-Fatal Wounds:</i></b> As long as the Lich-Lord Lenvan is alive, all your dead units will rise as undead regardless of cause of death. Choose if you want to lose them all forever or you prefer to let chance decide. You can still irretrievably lose your units forever if you are attacked by a unit with plague."
                image="misc/nfw-icon.png"
                [option]
                    label=_ "Disable Non-Fatal Wounds until Lord Lenvan dies"
                    default=yes
                    [command]
                        [fire_event]
                            name=nfw_lord_lenvan
                        [/fire_event]
                        [set_variable]
                            name=nfw_all_plagued
                            value=yes
                        [/set_variable]
                    [/command]
                [/option]
                [option]
                    label=_ "Continues normal Non-Fatal Wounds behavior"
                    # no action, just leave the NFW enabled
                [/option]
            [/message]
        [/case]
        [case]
            value=15_A_New_Land
            [message]
                speaker=narrator
                # po: For this scenario, the objective is to avoid deaths for as long as possible, the scenario ends when any unit perishes.
                message= _ "<b><i>Non-Fatal Wounds</i></b> modification does not affect the objectives for this scenario. The unit can survives, but still triggers the same events as if it died."
                image="misc/nfw-icon.png"
            [/message]
        [/case]
        [case]
            value=22_The_Rise_of_Wesnoth
            [message]
                speaker=narrator
                message=_ "<b><i>Non-Fatal Wounds:</i></b> As long as the Lich-Lord Jevyan is alive, all your dead units will rise as undead regardless of cause of death."
                image="misc/nfw-icon.png"
            [/message]
            [fire_event]
                name=nfw_lord_lenvan
            [/fire_event]
            [set_variable]
                name=nfw_all_plagued
                value=yes
            [/set_variable]
        [/case]
#endif
#ifdef CAMPAIGN_EASTERN_INVASION
        [case]
            value=12_Evacuation
            [message]
                speaker=narrator
                message= _ "<b><i>Non-Fatal Wounds:</i></b> Choose if you want units stranded on the other side of the bridge to always receive death wound or not. Units still on the recall list will die if the bridge is blown up. The rest will receive a wound according to the settings."
                image="misc/nfw-icon.png"
                [option]
                    label=_ "Kill all units stranded on the other side of the bridge"
                    default=yes
                    [command]
                        [set_variable]
                            name=nfw_kill_stranded
                            value=yes
                        [/set_variable]
                    [/command]
                [/option]
                [option]
                    label=_ "Continues normal Non-Fatal Wounds behavior"
                    # no action, just leave the NFW enabled
                [/option]
            [/message]
        [/case]
#endif
#ifdef CAMPAIGN_SON_OF_THE_BLACK_EYE
        [case]
            value=10_Saving_Inarix
            [message]
                speaker=narrator
                message= _ "<b><i>Non-Fatal Wounds:</i></b> All units stranded on the other side of the bridge, and the unit that sacrifices itself to blow the bridge up, will receive a death wound."
                image="misc/nfw-icon.png"
            [/message]
        [/case]
#endif
#ifdef CAMPAIGN_TO_LANDS_UNKNOWN
        [case]
            value=12_Siege_of_Mag-Magar
            [event]
                name=turn 5
                id=nfw_ally_malib_advice
                [message]
                    speaker=narrator
                    message= _ "<b><i>Non-Fatal Wounds:</i></b> All Malib units that join your side will receive a death wound in battle, as they will not be recoverable."
                    image="misc/nfw-icon.png"
                [/message]
            [/event]
        [/case]
#endif
#ifdef CAMPAIGN_WINDS_OF_FATE
        [case]
            value=03_The_Contention
            [message]
                speaker=narrator
                message= _ "<b><i>Non-Fatal Wounds</i></b> modification is disabled for this scenario."
                image="misc/nfw-icon.png"
            [/message]
            [remove_event]
                id=nfw_catch_last_breath,nfwe_rand_wound_table,nfwme_death_wounds,nfwme_elemental_wounds,nfwme_captured_heroes_wound,nfwme_mechanical_wound,nfwme_funny_wounds,nfwme_wound_filter
            [/remove_event]
            [set_variable]
                name=nfw_disabled
                value=yes
            [/set_variable]
            {CLEAR_VARIABLE nfw_wounded}
        [/case]
#endif
#ifdef ANEWORDER
        [case]
            value=04_Battle_of_Barnon
            [message]
                speaker=narrator
                message= _ "<b><i>Non-Fatal Wounds</i></b> modification is disabled for this scenario."
                image="misc/nfw-icon.png"
            [/message]
            [fire_event]
                name=nfw_disable_for_this_scenario
            [/fire_event]
            [set_variable]
                name=nfw_disabled
                value=yes
            [/set_variable]
            {CLEAR_VARIABLE nfw_wounded}
        [/case]
#endif
#ifdef CAMPAIGN_LEGEND_OF_THE_INVINCIBLES_PART_I
        [case]
            value=11_Ascension
            [message]
                speaker=narrator
                message= _ "<b><i>Non-Fatal Wounds</i></b> modification is disabled for this scenario."
                image="misc/nfw-icon.png"
            [/message]
            [remove_event]
                id=nfw_catch_last_breath,nfwe_rand_wound_table,nfwme_death_wounds,nfwme_elemental_wounds,nfwme_captured_heroes_wound,nfwme_mechanical_wound,nfwme_funny_wounds,nfwme_wound_filter
            [/remove_event]
            [set_variable]
                name=nfw_disabled
                value=yes
            [/set_variable]
            {CLEAR_VARIABLE nfw_wounded}
        [/case]
#endif
    [/switch]
[/event]

#ifdef CAMPAIGN_THE_RISE_OF_WESNOTH
[event]
    name=nfw_lord_lenvan
    [remove_event]
        id=nfw_catch_last_breath
    [/remove_event]
    {CLEAR_VARIABLE nfw_wounded}
    [event]
        name=last_breath
        first_time_only=no
        id=nfw_catch_lord_lenvan
        [filter]
            id=Lich-Lord Lenvan,Lich-Lord Jevyan
        [/filter]
        [set_variable]
            name=nfw_all_plagued
            value=no
        [/set_variable]
        [message]
            speaker=narrator
            message=_ "<b><i>Non-Fatal Wounds</i></b> works normally again."
            image="misc/nfw-icon.png"
        [/message]
        [event]
            name=last_breath
            first_time_only=no
            id=nfw_catch_last_breath_lenvan
            {NFW_CATCH_LAST_BREATH}
        [/event]
        [set_variable]
            name=nfw_disabled
            value=no
        [/set_variable]
    [/event]
[/event]

[event]
    name=last_breath
    id=nfw_lady_filter
    first_time_only=no
    [filter]
        id=Wesfolk Leader,Lady Outlaw
    [/filter]

    [switch]
        variable=current_scenario_id
        [case]
            value=02_The_Fall
            [if]
                {VARIABLE_CONDITIONAL have_lady equals 1}
                [then]
                    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Surrender" color="100,255,100"}
                [/then]
                [else]
                    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Escape" color="100,255,100"}
                [/else]
            [/if]
            {VARIABLE nfw_already_wound yes}
            {VARIABLE nfw_exclude_unit_id "Lady Outlaw,Wesfolk Leader"}
        [/case]
        [else]
            {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Escape" color="100,255,100"}
            {VARIABLE nfw_already_wound yes}
            {VARIABLE nfw_exclude_unit_id "Lady Outlaw"}
        [/else]
    [/switch]
[/event]
#endif

#ifdef CAMPAIGN_SON_OF_THE_BLACK_EYE
[event]
    name=last_breath
    id=nfw_execution_filter
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 08_Silent_Forest}
        {VARIABLE_CONDITIONAL nfw_death_trigger not_equals yes}
    [/filter_condition]
    [filter]
        side=2,3
    [/filter]
    {VARIABLE nfw_death_trigger yes}
    {VARIABLE nfw_already_wound yes}
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Execution" {NFW_COLOR_RED}}
[/event]

[event]
    name=last_breath
    id=nfw_frostbite_filter
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 14_Back_Home}
    [/filter_condition]
    [filter]
        id=Thelarion
    [/filter]
    {VARIABLE nfw_already_wound yes}
    {NFW_frostbite_WOUND}
[/event]

[event]
    name=last_breath
    id=nfw_bridge_sacrifice
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 10_Saving_Inarix}
        {VARIABLE_CONDITIONAL unit_detonating_says not_equals $nfw_empty_variable}
    [/filter_condition]
    [filter]
        side=1
        x,y=21,13
    [/filter]
    {VARIABLE nfw_bridge_destroyed yes}
[/event]

[event]
    name=last_breath
    id=nfw_bridge_abandoned
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 10_Saving_Inarix}
        {VARIABLE_CONDITIONAL nfw_bridge_destroyed equals yes}
    [/filter_condition]
    [filter]
        side=1
    [/filter]
    {NFW_dead_WOUND}
    {VARIABLE nfw_already_wound yes}
    {VARIABLE nfw_no_dialog yes}
[/event]
#endif

# LoW's scenario Costly Revenge is meant to kill off many of the player's own elves, before those elves become the other side of the elvish civil war. In single-player mode, give the player an option to disable the NFW mod near the end of that scenario, late enough that they'll be able to reload the autosave once they find out what the next battle is.

#ifdef CAMPAIGN_LOW
#ifndef MULTIPLAYER
[event]
    name=start
    [switch]
        variable=current_scenario_id
        [case]
            value=19_Costly_Revenge

            [event]
                name=capture
                first_time_only=yes
                [filter]
                    side=1
                    [not]
                        id=Landar
                    [/not]
                [/filter]

                [message]
                    speaker=narrator
                    message=_ "<b><i>Non-Fatal Wounds:</i></b> in all of mainline Wesnoth, this scenario is probably the most evil act by the player’s own side. The scenario is called Costly Revenge, and for the story it’s meant to be costly to the elves as well as these innocent saurians."
                    image="misc/nfw-icon.png"
                    [option]
                        label=_ "Disable Non-Fatal Wounds and let the story proceed as expected"
                        default=yes
                        [command]
                            [fire_event]
                                name=nfw_disable_for_this_scenario
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        label=_ "Let all the elves survive"
                        # no action, just leave the NFW enabled
                    [/option]
                [/message]
            [/event]
        [/case]
    [/switch]
[/event]
#endif
#endif

# In SotA, Shynal's death causes her to be raised as a walking corpse, so this specific death needs to be avoided without triggering the campaign's name=die event.
# She starts as a level 0, so it's likely that a player using this mod will put her in danger to try and level up.

# The mechanism to do this is to use kill=yes in the [store_unit] tag. That could be generalised, but let's have some campaign-specific dialogue instead.

#ifdef CAMPAIGN_SECRETS_OF_THE_ANCIENTS
[event]
    name=prestart
    {VARIABLE nfw_exclude_unit_id "Shynal"}
[/event]

[event]
    name=last_breath
    first_time_only=no
    id=nfw_catch_shynal
    [filter]
        id=Shynal
    [/filter]

    [message]
        speaker=Shynal
        message= _ "Ow, that was close. I’ll rest until the next battle."
    [/message]
    [if]
        [have_unit]
            id=Carcyn
        [/have_unit]
        [then]
            [message]
                speaker=Carcyn
                message= _ "You could have brought her back anyway, right?"
            [/message]
            [if]
                # This can't use have_unit, because that filters out units with zero hp
                [variable]
                    name=unit.race
                    equals="human"
                [/variable]
                [then]
                    [message]
                        speaker=Ras-Tabahn
                        # po: without this mod, she's brought back as a walking corpse
                        message= _ "Only in part. She would never have the powers of a lich."
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker=Ras-Tabahn
                        message= _ "Maybe as a ghost, but even then she would no longer have the powers of a lich."
                    [/message]
                [/else]
            [/if]
        [/then]
    [/if]

    [store_unit]
        [filter]
            {EVENT_UNIT}
        [/filter]
        mode=append
        variable=nfw_wounded
        kill=yes
    [/store_unit]
[/event]

[event]
    name=nfw_disable_for_this_scenario
    [remove_event]
        id=nfw_catch_shynal
    [/remove_event]
[/event]
#endif

# UtBS S02's events clear the dehydration status in a victory event. One option would be to copy
# that code here, and hope that it doesn't change; another option is to spawn the clones of the
# wounded units before the victory event fires.
#
# As this is a single-player campaign, the local_victory event is guaranteed to fire, and it's
# unit-tested to fire before victory (in data/test/scenarios/events-test_victory.cfg).

#ifdef CAMPAIGN_UNDER_THE_BURNING_SUNS
[event]
    name=start
    [switch]
        variable=current_scenario_id
        [case]
            value=02_Across_the_Harsh_Sands
            [event]
                name=local_victory
                [foreach]
                    array=nfw_wounded
                    [do]
                        [if]
                            [variable]
                                name=this_item.side
                                equals=1
                            [/variable]
                            [then]
                                # For UtBS' victory event to find them, they have to be spawned onto
                                # the map instead of the recall list. Putting them on the map means
                                # they also get the usual end-of-scenario healing and curing, so
                                # leave them at 1 hp as a hint to the player about where these units
                                # came from.
                                {VARIABLE this_item.hitpoints 1}
                                [unstore_unit]
                                    variable=this_item
                                    x,y=1,1
                                    find_vacant=yes
                                    animate=no
                                    advance=no
                                [/unstore_unit]
                            [/then]
                        [/if]
                    [/do]
                [/foreach]
                # Ensure that no duplicates appear
                {CLEAR_VARIABLE nfw_wounded}
            [/event]
        [/case]
    [/switch]
[/event]

[event]
    name=last_breath
    id=nfw_alien_filter
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 12_The_Final_Confrontation}
    [/filter_condition]
    [filter]
        type=Central Body2,Crawling Horror,Pulsing Spire
    [/filter]
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Destruction" {NFW_COLOR_RED}}
    {VARIABLE nfw_already_wound yes}
[/event]
#endif

#ifdef CAMPAIGN_EASTERN_INVASION
[event]
    name=last_breath
    id=nfw_bridge_destroyed
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 12_Evacuation}
        {VARIABLE_CONDITIONAL nfw_kill_stranded equals yes}
        [have_location]
            x=8
            y=18
            terrain=Wo
        [/have_location]
    [/filter_condition]
    {NFW_dead_WOUND}
    {VARIABLE nfw_already_wound yes}
    {VARIABLE nfw_no_dialog yes}
[/event]
#endif

# Collar of Recall properly works. No wound the first three times, and death the third time.
#ifdef CAMPAIGN_TO_LANDS_UNKNOWN
[event]
    name=last_breath
    id=nfw_collar_filter
    first_time_only=no
    [filter]
        status=collar
        [and]
            status=thirdrecall
        [/and]
    [/filter]
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Disipated" {NFW_COLOR_RED}}
    {VARIABLE nfw_already_wound yes}
    {VARIABLE nfw_exclude_unit_id $unit.id}
[/event]

[event]
    name=last_breath
    id=nfw_witch_suicide
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 12_Siege_of_Mag}
    [/filter_condition]
    [filter]
        id=Matriarch3
    [/filter]
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Suicide" {NFW_COLOR_RED}}
    {VARIABLE nfw_already_wound yes}
[/event]

[event]
    name=last_breath
    id=nfw_reficul_banish
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 15_Abyssal_Rebellion}
    [/filter_condition]
    [filter]
        id=Reficul
    [/filter]
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Banished" {NFW_COLOR_RED}}
    {VARIABLE nfw_already_wound yes}
[/event]

[event]
    name=last_breath
    id=nfw_rasti_inmortal
    first_time_only=no
    [filter]
        type=TLU_DharmaRashti,TLU_HoRashti,TLU_True_Rashti,TLU_HoRashti
        [or]
            id=Master
        [/or]
    [/filter]
    {VARIABLE nfw_already_wound yes}
[/event]

[event]
    name=last_breath
    id=nfw_mages_no_wound
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 19_Sky_Kingdom}
    [/filter_condition]
    [filter]
        race=human
        [or]
            type=EoMa_Master_of_Fire
        [/or]
    [/filter]
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Vanished" color="0,255,255"}
    {VARIABLE nfw_already_wound yes}
    {VARIABLE nfw_already_vanished $unit.id}
[/event]

[event]
    name=last_breath
    id=nfw_collar_death
    first_time_only=no
    [filter]
        status=collar
        [not]
            status=thirdrecall
        [/not]
    [/filter]
    {NFW_dead_WOUND}
    {VARIABLE nfw_already_wound yes}
[/event]

[event]
    name=last_breath
    id=nfw_ally_malib_death
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 12_Siege_of_Mag}
    [/filter_condition]
    [filter]
        ability=temp_ally
    [/filter]
    {NFW_dead_WOUND}
    {VARIABLE nfw_already_wound yes}
[/event]
#endif

#ifdef ANEWORDER
[event]
    name=last_breath
    id=nfw_robroe_hired
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 08_Outlaw_Base}
        {VARIABLE_CONDITIONAL ano_robroe_hired equals yes}
    [/filter_condition]
    [filter]
        id=Outlaw Leader
    [/filter]
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Hire" color="100,255,100"}
    {VARIABLE nfw_already_wound yes}
[/event]

[event]
    name=victory
    id=nfw_append_variable
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 08_Outlaw_Base}
    [/filter_condition]
    [foreach]
        array=nfw_wounded
        [do]
            {VARIABLE this_item.hitpoints $this_item.max_hitpoints}
            {VARIABLE this_item.status.poisoned "no"}
            {VARIABLE this_item.status.slowed "no"}
            [unstore_unit]
                variable=this_item
                x,y=recall,recall
                advance=no
            [/unstore_unit]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE nfw_wounded}
    [store_unit]
        [filter]
            side=1
            [not]
                find_in=ano_gawen_units
            [/not]
        [/filter]
        mode=append
        variable=ano_gawen_units
        kill=yes
    [/store_unit]
[/event]
#endif

#ifdef CAMPAIGN_LEGEND_OF_THE_INVINCIBLES_PART_I
[event]
    name=last_breath
    id=nfw_ascension_deactivated
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 11_Ascension}
    [/filter_condition]
    [filter]
        canrecruit=yes
    [/filter]
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Enslaved" color="100,255,100"}
[/event]

[event]
    name=last_breath
    id=nfw_zorox_captured
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 14_Shadow_Empire}
    [/filter_condition]
    [filter]
        id=Zorox
    [/filter]
    [filter_second]
        id=Lethalia
    [/filter_second]
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Captured" color="100,255,100"}
    {VARIABLE nfw_already_wound yes}
[/event]

[event]
    name=last_breath
    id=nfw_umbra_vanished
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 01_The_Beginning}
    [/filter_condition]
    [filter]
        id=Umbra_illusion
    [/filter]
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Vanished" color="100,255,100"}
    {VARIABLE nfw_already_wound yes}
[/event]

[event]
    name=last_breath
    id=nfw_elven_raised
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 01_The_Beginning}
        [or]
            {VARIABLE_CONDITIONAL current_scenario_id equals 02_Gods}
        [/or]
    [/filter_condition]
    [filter]
        id=Shiva,Zambag,Lotor,Ghargalla,Tholor,Ghar`drias,Undoloria,Gar`landak,Ghambar,Khar_dhas,Emraldhor,Amgharth,Ufa,Durandia
    [/filter]
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Raised" {NFW_COLOR_RED}}
    {VARIABLE nfw_already_wound yes}
[/event]

[event]
    name=last_breath
    id=nfwm_doppelganger
    first_time_only=no
    [filter]
        type=Lethalia_doppelganger,Efraim_doppelganger
    [/filter]
    {NFW_FLOAT_TEXT_SCROLL $x1 $y1 _"Disipated" {NFW_COLOR_RED}}
    {VARIABLE nfw_already_wound yes}
[/event]

[event]
    name=last_breath
    id=nfw_delly_killed
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 07_Nemesis}
    [/filter_condition]
    [filter]
        type=Delly_lich
    [/filter]
    {NFW_FLOAT_TEXT_CONDITIONAL $x1 $y1 _"Death" {NFW_COLOR_RED}}
    {VARIABLE nfw_already_wound yes}
    {VARIABLE nfw_exclude_unit_id $unit.id}
[/event]

# On this scenario all surviving and wounded units from side 1 are saved in prevamp_store instead of normal way
[event]
    name=prestart
    id=nfw_loti_revolution
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 03_Revolution_Begins}
    [/filter_condition]
    [remove_event]
        id=nfw_victory_unstore
    [/remove_event]
[/event]

[event]
    name=victory
    id=nfw_loti_prevamp_store
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 03_Revolution_Begins}
    [/filter_condition]
    [foreach]
        array=nfw_wounded
        [do]
            {VARIABLE this_item.hitpoints $this_item.max_hitpoints}
            {VARIABLE this_item.status.poisoned "no"}
            {VARIABLE this_item.status.slowed "no"}
            [if]
                [variable]
                    name=this_item.side
                    equals=1
                [/variable]
                [then]
                    [set_variables]
                        name=prevamp_store
                        mode=append
                        to_variable=this_item
                    [/set_variables]
                [/then]
                [else]
                    [unstore_unit]
                        variable=this_item
                        x,y=recall,recall
                        advance=no
                    [/unstore_unit]
                [/else]
            [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE nfw_wounded,nfw_alive_units}
[/event]

# All wounded units are killed, because without this, there may be an excess of units. Does not include units with ghost, undead, angel, devil or elemental wounds
[event]
    name=prestart
    id=nfw_loti_mass_produced
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 10_Dealing_with_Trolls}
    [/filter_condition]
    [kill]
        [filter_wml]
            [variables]
                mass_produced=yes
            [/variables]
        [/filter_wml]
        ability=nfw_coward_display,nfw_concussion_display,nfw_captured_unit_display,nfw_burned_display,nfw_broken_rib_display,nfw_broken_arm_display,nfw_broken_wing_display,nfw_broken_leg_display,nfw_burned_display,nfw_scared_of_weapon,nfw_scared_of_type,nfw_scared_of_light,nfw_scared_of_dark,nfw_frostbite_display,nfw_gash_display,nfw_fear_of_water_display,nfw_fear_of_hight_display,nfw_fear_of_cave_display,nfw_fear_of_plant_display,nfw_fear_of_open_display,nfw_fear_of_fog_display,nfw_infection_display,nfw_insanity_display,nfw_maimed_display,nfw_necrosis_display,nfw_amnesia_display,nfw_sick_display,nfw_wild_magic_display,nfw_damaged_display,nfw_paper_cut_display,nfw_lego_display,nfw_dumb_display
        side=1
        upkeep=loyal
        type=Skeleton,Ghost,Walking Corpse
        animate=no
        fire_event=no
    [/kill]
[/event]
[event]
    name=start
    id=nfw_loti_mass_produced_message
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 11_Invasion}
    [/filter_condition]
    [message]
        message="<b><i>Non-Fatal Wounds:</i></b> All level 1 wounded loyal units in the undead army have been eliminated. Turned into ghost, elemental, angel, and devil are an exception."
        speaker=narrator
        image="misc/nfw-icon.png"
    [/message]
[/event]

# Units are killed in the victory event of the scenario, but it doesn't kill units on nfw_wounded, because it's right after. With this, all units of the undead army are eliminated.
[event]
    name=prestart
    id=nfw_loti_mass_produced_2
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 13_The_Way_of_Assassins}
    [/filter_condition]
    [kill]
        [filter_wml]
            [variables]
                mass_produced=yes
            [/variables]
        [/filter_wml]
        animate=no
        fire_event=no
    [/kill]
[/event]

[event]
    name=last_breath
    id=nfw_pirate_killed
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 03_Pirates}
    [/filter_condition]
    [filter]
        id=enemy
    [/filter]
    [if]
        {VARIABLE_CONDITIONAL thankful_enemy[0].id equals thankful_enemy}
        [then]
            {NFW_FLOAT_TEXT_CONDITIONAL $x1 $y1 _"Surrender" color="100,255,100"}
        [/then]
        [else]
            {NFW_FLOAT_TEXT_CONDITIONAL $x1 $y1 _"Death" {NFW_COLOR_RED}}
        [/else]
    [/if]
    {VARIABLE nfw_already_wound yes}
    {VARIABLE nfw_exclude_unit_id enemy}
[/event]

[event]
    name=last_breath
    id=nfw_akula_teleport
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL current_scenario_id equals 05_We_Walk_in_the_Shadows}
    [/filter_condition]
    [filter]
        id=Akula
    [/filter]
    {NFW_FLOAT_TEXT_CONDITIONAL $x1 $y1 _"Teleported" color="100,255,100"}
    {VARIABLE nfw_already_wound yes}
    {VARIABLE nfw_exclude_unit_id Akula}
[/event]
#endif

# Disable the mod on scenarios with {IS_LAST_SCENARIO}, both because there's no further recalls and because the ending may change slightly depending on which units die in the final battle.
# This can't check for next_scenario=null, as many campaigns have an epilogue scenario.
# Reading wesnoth.sides[x].objectives might be possible, but that's only available as the translated string.
[event]
    name=start
    [filter_condition]
        [lua]
            code=<<
                local result = wesnoth.sync.evaluate_single (function()
                    local _ = wesnoth.textdomain "wesnoth"
                    return { value = string.find(tostring(wesnoth.sides[1].objectives), tostring(_ "This is the last scenario."), 1, "plain")}
                    end)
                return result.value
            >>
        [/lua]
    [/filter_condition]
    #textdomain wesnoth-Non_Fatal_Wounds
    [message]
        speaker=narrator
        message= _"<b><i>Non-Fatal Wounds: </i></b>"+_"Because this is the last scenario, all units can die, without exception, and will count as such for the ending scene."
        image="misc/nfw-icon.png"
    [/message]
    [fire_event]
        name=nfw_disable_for_this_scenario
    [/fire_event]
[/event]
