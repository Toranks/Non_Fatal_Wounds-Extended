#textdomain wesnoth-Non_Fatal_Wounds

# generate variables used on wounds and filters
[event]
    name=last_breath
    id=nfwme_store_variables
    first_time_only=no
    {VARIABLE nfw_weapon_type $second_weapon.type}
    {VARIABLE nfw_scary_weapon $second_weapon.name}
    {VARIABLE nfw_scary_weapon_translated $second_weapon.description}
    [store_unit_type]
        type=$unit.type
        variable=nfwe_unit_type
    [/store_unit_type]
    [store_unit_type]
        type=$second_unit.type
        variable=nfwe_second_unit_type
    [/store_unit_type]
[/event]

# souls catched by the Dimensional Gate
[event]
    name=last_breath,die
    id=nfwme_soul_catcher
    first_time_only=no
    [filter]
        [not]
            race=mechanical,undead
        [/not]
    [/filter]
    [filter_second]
        ability=soul_catcher
    [/filter_second]
    [filter_condition]
        {VARIABLE_CONDITIONAL nfwe_wounds not_equals 1}
        {VARIABLE_CONDITIONAL nfw_already_vanished not_equals $unit.id}
        {VARIABLE_CONDITIONAL current_scenario_id not_equals 19_Sky_Kingdom}
    [/filter_condition]
    [if]
        {VARIABLE_CONDITIONAL nfwe_already_catched not_equals $unit.id}
        [then]
            {NFW_soul_catched_WOUND}
            {VARIABLE nfwe_already_catched $unit.id}
        [/then]
    [/if]
    {VARIABLE nfw_already_wound yes}
[/event]

# Dimensional Gate always is destroyed
[event]
    name=last_breath
    id=nfw_dimensional_gate
    first_time_only=no
    [filter]
        type=EoMa_Dimensional_Gate,EoMa_Dimensional_Gate_II
    [/filter]
    [filter_condition]
        {VARIABLE_CONDITIONAL nfw_already_wound not_equals yes}
    [/filter_condition]
    {NFW_destroyed_WOUND}
    {VARIABLE nfw_already_wound yes}
[/event]

# Gate always is destroyed
[event]
    name=last_breath
    id=nfw_gate
    first_time_only=no
    [filter]
        type=Gate
    [/filter]
    {NFW_destroyed_WOUND}
    {VARIABLE nfw_already_wound yes}
[/event]

# filter plagueable plagued units
[event]
    name=last_breath
    id=nfwme_death_plague
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL nfw_all_plagued not_equals yes}
        {VARIABLE_CONDITIONAL nfwe_wounds not_equals 1}
    [/filter_condition]
    [filter]
        [not]
            status=unplagueable
        [/not]
        [not]
            [filter_location]
                terrain=*^V*
            [/filter_location]
        [/not]
    [/filter]
    [filter_second_attack]
        special_type=plague
    [/filter_second_attack]
    {NFW_plagued_WOUND}
    {VARIABLE nfw_already_wound yes}
[/event]

# filter forced plagued for some scenarios
[event]
    name=last_breath
    id=nfwme_death_plague_forced
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL nfw_all_plagued equals yes}
    [/filter_condition]
    [filter]
        side=1
        [not]
            id=Commander Aethyr
        [/not]
    [/filter]
    {NFW_plagued_WOUND}
    {VARIABLE nfw_already_wound yes}
[/event]

# filter heroes
[event]
    name=last_breath
    id=nfwme_captured_heroes_wound
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL nfw_already_wound not_equals yes}
        {NFW_wounds_ENABLED}
    [/filter_condition]
    [filter]
        {NFW_FILTER_HEROES}
#ifdef CAMPAIGN_NORTHERN_REBIRTH
        [not]
            id=Sister Thera,Father Morvin
        [/not]
#endif
    [/filter]
    {VARIABLE_OP rand_wound rand "1..4"}
    [switch]
        variable=rand_wound
        [case]
            value=1
            {NFW_captured_WOUND}
            {VARIABLE nfw_already_wound yes}
        [/case]
    [/switch]
[/event]

# filter mechanical units, included death (destroyed)
[event]
    name=last_breath
    id=nfwme_mechanical_wound
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL nfw_already_wound not_equals yes}
    [/filter_condition]
    [filter]
        race=mechanical
        [or]
            trait=mechanical
        [/or]
    [/filter]
    {VARIABLE_OP rand_wound rand "1..20"}
    [switch]
        variable=rand_wound
        [case]
            value=1,2,3,4
            [if]
                {VARIABLE_CONDITIONAL nfwe_deadundead greater_than 0}
                [then]
                    {NFW_destroyed_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
                [elseif]
                    {NFW_wounds_ENABLED}
                    [then]
                        {NFW_damaged_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
            [/if]
        [/case]
    [/switch]
    [if]
        {NFW_wounds_ENABLED}
        [then]
            [switch]
                variable=rand_wound
                [case]
                    value=5,6,7
                    {NFW_damaged_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/case]
                [case]
                    value=8,9
                    {NFW_captured_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/case]
                [case]
                    value=10,11
                    {NFW_rotten_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/case]

                [case]
                    value=12,13,14,15
                    [if]
                        {VARIABLE_CONDITIONAL nfw_weapon_type equals fire}
                        [then]
                            {NFW_burned_WOUND}
                            {VARIABLE nfw_already_wound yes}
                        [/then]
                        [elseif]
                            {VARIABLE_CONDITIONAL nfw_weapon_type equals ice}
                            [then]
                                {NFW_frostbite_WOUND}
                                {VARIABLE nfw_already_wound yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=*^Ecf,*^Eb,Ql*,Mv*,Yl*
                            [/have_location]
                            [then]
                                {NFW_burned_WOUND}
                                {VARIABLE nfw_already_wound yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=A*,Ms*,Ha*,Cea^*,Coa^*,Cha^*,Cva^*,Cfa^*,Kea^*,Koa^*,Kha^*,Kva^*,Kfa^*,Rra^*,*^Esa,*^Fpa,*^Feta,*^Fda,*^Fma,*^Voa,*^Vea,*^Vha,*^Vhca,*^Vhha,*^Vca,*^Vla,*^Vaa
                            [/have_location]
                            [then]
                                {NFW_frostbite_WOUND}
                                {VARIABLE nfw_already_wound yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            {VARIABLE_CONDITIONAL nfw_weapon_type equals impact}
                            [or]
                                {VARIABLE_CONDITIONAL nfw_weapon_type equals arcane}
                            [/or]
                            [then]
                                {NFW_rotten_WOUND}
                                {VARIABLE nfw_already_wound yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            {VARIABLE_CONDITIONAL nfw_weapon_type equals blade}
                            [then]
                                {NFW_gash_WOUND}
                                {VARIABLE nfw_already_wound yes}
                            [/then]
                        [/elseif]
                        [else]
                            {NFW_damaged_WOUND}
                            {VARIABLE nfw_already_wound yes}
                        [/else]
                    [/if]
                [/case]
                [case]
                    value=16,17,18,19,20
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                formula="experience > (max_experience / 1.5)"
                            [/filter]
                        [/have_location]
                        [and]
                            [have_location]
                                {EVENT_UNIT}
                                [filter]
                                    [filter_wml]
                                        [advancement]
                                            glob_on_id=*
                                        [/advancement]
                                    [/filter_wml]
                                [/filter]
                            [/have_location]
                            [or]
                                {VARIABLE_CONDITIONAL unit.advances_to not_equals $nfw_empty_var}
                                [and]
                                    {VARIABLE_CONDITIONAL unit.advances_to not_equals ""}
                                [/and]
                            [/or]
                        [/and]
                        [then]
                            {NFW_short_term_memory_loss_WOUND}
                            {VARIABLE nfw_already_wound yes}
                        [/then]
                        [else]
                            [if]
                                [have_location]
                                    {EVENT_UNIT}
                                    [filter]
                                        ability=amnesia_dummy
                                    [/filter]
                                [/have_location]
                                [then]
                                    {NFW_damaged_WOUND}
                                    {VARIABLE nfw_already_wound yes}
                                [/then]
                                [elseif]
                                    {VARIABLE_CONDITIONAL rand_wound greater_than 18}
                                    [and]
                                        [have_location]
                                            {EVENT_UNIT}
                                            [filter]
                                                [filter_wml]
                                                    [advancement]
                                                        glob_on_id=*
                                                    [/advancement]
                                                [/filter_wml]
                                            [/filter]
                                        [/have_location]
                                        [or]
                                            {VARIABLE_CONDITIONAL unit.advances_to not_equals $nfw_empty_var}
                                            [and]
                                                {VARIABLE_CONDITIONAL unit.advances_to not_equals ""}
                                            [/and]
                                        [/or]
                                    [/and]
                                    [then]
                                        {NFW_amnesia_WOUND}
                                        {VARIABLE nfw_already_wound yes}
                                    [/then]
                                [/elseif]
                                [else]
                                    {NFW_damaged_WOUND}
                                    {VARIABLE nfw_already_wound yes}
                                [/else]
                            [/if]
                        [/else]
                    [/if]
                [/case]
            [/switch]
        [/then]
    [/if]
[/event]

# filter with death not mechanical
[event]
    name=last_breath
    id=nfwme_death_wounds
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL nfw_already_wound not_equals yes}
        {VARIABLE_CONDITIONAL nfwe_deadundead greater_than 0}
    [/filter_condition]
#ifdef CAMPAIGN_NORTHERN_REBIRTH
    [filter]
        [not]
            id=Sister Thera,Father Morvin
        [/not]
    [/filter]
#endif
    {VARIABLE_OP rand_wound rand "1..21"}
    [switch]
        variable=rand_wound
        [case]
            value=1,2,3,4
            {NFW_dead_WOUND}
            {VARIABLE nfw_already_wound yes}
        [/case]
        [case]
            value=5,6
            [if]
                {NFW_undead_ENABLED}
                [and]
                    [not]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                race=undead,eoma_magical
                                [or]
                                    trait=elemental,undead,magical
                                [/or]
                            [/filter]
                        [/have_location]
                    [/not]
                [/and]
                [then]
                    {NFW_undead_corpse_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
                [else]
                    {NFW_dead_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/else]
            [/if]
        [/case]
        [case]
            value=7
            [if]
                {NFW_undead_ENABLED}
                {VARIABLE_CONDITIONAL nfwe_unit_type.movement_type not_equals undeadspirit}
                {VARIABLE_CONDITIONAL nfwe_unit_type.race not_equals eoma_magical}
                [and]
                    [not]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                trait=ghost_trait,undead,elemental,magical
                            [/filter]
                        [/have_location]
                    [/not]
                [/and]
                [then]
                    {NFW_undead_ghost_WOUND {TRAIT_UNDEAD}}
                    {VARIABLE nfw_already_wound yes}
                [/then]
                [elseif]
                    {NFW_undead_ENABLED}
                    {VARIABLE_CONDITIONAL nfwe_unit_type.movement_type not_equals undeadspirit}
                    {VARIABLE_CONDITIONAL nfwe_unit_type.race not_equals eoma_magical}
                    [and]
                        [not]
                            [have_location]
                                {EVENT_UNIT}
                                [filter]
                                    trait=ghost_trait,elemental,magical
                                [/filter]
                            [/have_location]
                        [/not]
                    [/and]
                    [and]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                trait=undead
                            [/filter]
                        [/have_location]
                    [/and]
                    [then]
                        {NFW_undead_ghost_WOUND {NFW_TRAIT_UNDEAD}}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [else]
                    {NFW_dead_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/else]
            [/if]
        [/case]
        [case]
            value=8,9,10,11,12,13,14
            [if]
                [have_location]
                    {EVENT_UNIT}
                    [filter]
                        [has_attack]
                            range=kamikaze
                        [/has_attack]
                    [/filter]
                [/have_location]
                [then]
                    {NFW_dead_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
            [/if]
        [/case]
    [/switch]
[/event]

# filter elemental wounds
[event]
    name=last_breath
    id=nfwme_elemental_wounds
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL nfw_already_wound not_equals yes}
        {NFW_elemental_ENABLED}
        {VARIABLE_CONDITIONAL nfwe_unit_type.movement_type not_equals undeadspirit}
    [/filter_condition]
    [filter]
#ifdef CAMPAIGN_NORTHERN_REBIRTH
        [not]
            id=Sister Thera,Father Morvin
        [/not]
#endif
        [not]
            race=undead,eoma_magical
        [/not]
        [not]
            trait=ghost_trait,undead,elemental,magical
        [/not]
    [/filter]
    {VARIABLE_OP rand_wound rand "1..40"}
    [switch]
        variable=rand_wound
        [case]
            value=1,2
            [if]
                [have_location]
                    {EVENT_UNIT}
                    terrain=Qxua
                [/have_location]
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            [has_attack]
                                type=arcane
                            [/has_attack]
                        [/filter]
                    [/have_location]
                [/or]
                [or]
                    {VARIABLE_CONDITIONAL nfw_weapon_type equals arcane}
                [/or]
                [then]
                    {NFW_elemental_arcane_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
            [/if]
        [/case]
        [case]
            value=3
            [if]
                {VARIABLE_CONDITIONAL nfw_weapon_type equals pierce}
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            status=poisoned
                        [/filter]
                    [/have_location]
                [/or]
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            [has_attack]
                                special_type=poison
                            [/has_attack]
                        [/filter]
                    [/have_location]
                [/or]
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            [has_attack]
                                type=pierce
                            [/has_attack]
                        [/filter]
                    [/have_location]
                [/or]
                [then]
                    {NFW_elemental_poison_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
            [/if]
        [/case]
        [case]
            value=4
            [if]
                {VARIABLE_CONDITIONAL nfw_weapon_type equals blade}
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        terrain=*^Wm,^Vwm
                    [/have_location]
                [/or]
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            race=bats,falcon,gryphon,bird,eoma_roc
                        [/filter]
                    [/have_location]
                [/or]
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            [has_attack]
                                type=blade
                            [/has_attack]
                        [/filter]
                    [/have_location]
                [/or]
                [then]
                    {NFW_elemental_air_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
            [/if]
        [/case]
        [case]
            value=5,6
            [if]
                {VARIABLE_CONDITIONAL nfw_weapon_type equals fire}
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        terrain=*^Ecf,*^Eb,Ql*,Mv*,Yl*
                    [/have_location]
                [/or]
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            [has_attack]
                                type=fire
                            [/has_attack]
                        [/filter]
                    [/have_location]
                [/or]
                [then]
                    {NFW_elemental_fire_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
            [/if]
        [/case]
        [case]
            value=7,8
            [if]
                {VARIABLE_CONDITIONAL nfw_weapon_type equals cold}
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        terrain=A*,W*,S*,Ms*,Ha*,Cea^*,Coa^*,Cha^*,Cva^*,Cfa^*,Kea^*,Koa^*,Kha^*,Kva^*,Kfa^*,Rra^*,*^Esa,*^Fpa,*^Feta,*^Fda,*^Fma,*^Voa,*^Vea,*^Vha,*^Vhca,*^Vhha,*^Vca,*^Vla,*^Vaa
                    [/have_location]
                [/or]
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            [has_attack]
                                type=cold
                            [/has_attack]
                        [/filter]
                    [/have_location]
                [/or]
                [then]
                    {NFW_elemental_water_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
            [/if]
        [/case]
        [case]
            value=9,10
            [if]
                {VARIABLE_CONDITIONAL nfw_weapon_type equals impact}
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            [has_attack]
                                type=impact
                            [/has_attack]
                        [/filter]
                    [/have_location]
                [/or]
                [or]
                    [have_location]
                        {EVENT_UNIT}
                        terrain=U*
                    [/have_location]
                [/or]
                [then]
                    {NFW_elemental_earth_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
            [/if]
        [/case]
        [case]
            value=11,12,13,14,15
            [if]
                [have_location]
                    {EVENT_UNIT}
                    terrain=Qxua
                [/have_location]
                [then]
                    {NFW_elemental_arcane_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
                [elseif]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            status=poisoned
                        [/filter]
                    [/have_location]
                    [then]
                        {NFW_elemental_poison_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    [have_location]
                        {EVENT_UNIT}
                        terrain=*^Wm,^Vwm
                    [/have_location]
                    [then]
                        {NFW_elemental_air_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    {VARIABLE_CONDITIONAL nfw_weapon_type equals fire}
                    [or]
                        [have_location]
                            {EVENT_UNIT}
                            terrain=*^Ecf,*^Eb,Ql*,Mv*,Yl*
                        [/have_location]
                    [/or]
                    [then]
                        {NFW_elemental_fire_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    {VARIABLE_CONDITIONAL nfw_weapon_type equals arcane}
                    [then]
                        {NFW_elemental_arcane_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    {VARIABLE_CONDITIONAL nfw_weapon_type equals cold}
                    [or]
                        [have_location]
                            {EVENT_UNIT}
                            terrain=A*,W*,S*,Ms*,Ha*,Cea^*,Coa^*,Cha^*,Cva^*,Cfa^*,Kea^*,Koa^*,Kha^*,Kva^*,Kfa^*,Rra^*,*^Esa,*^Fpa,*^Feta,*^Fda,*^Fma,*^Voa,*^Vea,*^Vha,*^Vhca,*^Vhha,*^Vca,*^Vla,*^Vaa
                        [/have_location]
                    [/or]
                    [then]
                        {NFW_elemental_water_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            [has_attack]
                                special_type=poison
                            [/has_attack]
                        [/filter]
                    [/have_location]
                    [then]
                        {NFW_elemental_poison_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    [have_location]
                        {EVENT_UNIT}
                        terrain=U*
                    [/have_location]
                    [then]
                        {NFW_elemental_earth_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            race=naga,merman
                        [/filter]
                    [/have_location]
                    [or]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                [has_attack]
                                    type=cold
                                [/has_attack]
                            [/filter]
                        [/have_location]
                    [/or]
                    [then]
                        {NFW_elemental_water_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            [has_attack]
                                type=arcane
                            [/has_attack]
                        [/filter]
                    [/have_location]
                    [then]
                        {NFW_elemental_arcane_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            [has_attack]
                                type=fire
                            [/has_attack]
                        [/filter]
                    [/have_location]
                    [then]
                        {NFW_elemental_fire_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    [have_location]
                        {EVENT_UNIT}
                        [filter]
                            race=bats,falcon,gryphon,bird,eoma_roc
                        [/filter]
                    [/have_location]
                    [then]
                        {NFW_elemental_air_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    {VARIABLE_CONDITIONAL nfw_weapon_type equals impact}
                    [or]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                [has_attack]
                                    type=impact
                                [/has_attack]
                            [/filter]
                        [/have_location]
                    [/or]
                    [then]
                        {NFW_elemental_earth_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    {VARIABLE_CONDITIONAL nfw_weapon_type equals blade}
                    [or]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                [has_attack]
                                    type=blade
                                [/has_attack]
                            [/filter]
                        [/have_location]
                    [/or]
                    [then]
                        {NFW_elemental_air_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
                [elseif]
                    {VARIABLE_CONDITIONAL nfw_weapon_type equals pierce}
                    [or]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                [has_attack]
                                    type=pierce
                                [/has_attack]
                            [/filter]
                        [/have_location]
                    [/or]
                    [then]
                        {NFW_elemental_poison_WOUND}
                        {VARIABLE nfw_already_wound yes}
                    [/then]
                [/elseif]
            [/if]
        [/case]
    [/switch]
[/event]

# filter funny wounds
[event]
    name=last_breath
    id=nfwme_funny_wounds
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL nfw_already_wound not_equals yes}
        {NFW_funny_ENABLED}
    [/filter_condition]
#ifdef CAMPAIGN_NORTHERN_REBIRTH
    [filter]
        [not]
            id=Sister Thera,Father Morvin
        [/not]
    [/filter]
#endif
    {VARIABLE_OP rand_wound rand "1..50"}
    [switch]
        variable=rand_wound
        [case]
            value=1
            {NFW_paper_cut_WOUND}
            {VARIABLE nfw_already_wound yes}
        [/case]
        [case]
            value=2
            {NFW_stepped_on_lego_WOUND}
            {VARIABLE nfw_already_wound yes}
        [/case]
        [case]
            value=3
            {NFW_jinx_WOUND}
            {VARIABLE nfw_already_wound yes}
        [/case]
        [case]
            value=7,8,9,10,11,12,13,14,15,16,17,18,19
            [if]
                [have_location]
                    {EVENT_UNIT}
                    [filter]
                        [has_attack]
                            name=curse
                        [/has_attack]
                    [/filter]
                [/have_location]
                [then]
                    {NFW_jinx_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
            [/if]
        [/case]
        [case]
            value=4
            {NFW_dumb_WOUND}
            {VARIABLE nfw_already_wound yes}
        [/case]
        [case]
            value=31,32,33,34,35,36,37,38,39,40,41,42,43
            [if]
                [have_location]
                    {EVENT_UNIT}
                    [filter]
                        [has_attack]
                            name=sling
                        [/has_attack]
                    [/filter]
                [/have_location]
                [then]
                    {NFW_dumb_WOUND}
                    {VARIABLE nfw_already_wound yes}
                [/then]
            [/if]
        [/case]
        [case]
            value=5
            {NFW_angel_WOUND}
            {VARIABLE nfw_already_wound yes}
        [/case]
        [case]
            value=6
            {NFW_devil_WOUND}
            {VARIABLE nfw_already_wound yes}
        [/case]
    [/switch]
[/event]

# random wound table trigger
[event]
    name=last_breath
    id=nfwme_wound_filter
    first_time_only=no

    [if]
        {VARIABLE_CONDITIONAL nfw_already_wound equals yes}
        [then]
            {CLEAR_VARIABLE nfw_already_wound}
        [/then]
        [elseif]
            {VARIABLE_CONDITIONAL nfwe_wounds greater_than 0}
            [then]
                {NFW_retreat_WOUND}
            [/then]
        [/elseif]
        [else]
            [fire_event]
                name=nfwe_rand_wound
                [primary_unit]
                    {EVENT_UNIT}
                [/primary_unit]
                [secondary_unit]
                    {EVENT_SECOND_UNIT}
                [/secondary_unit]
            [/fire_event]
        [/else]
    [/if]
[/event]

[event]
    name=nfwe_rand_wound
    id=nfwe_rand_wound_table
    first_time_only=no
    [while]
        {VARIABLE_CONDITIONAL rand_wound_selected not_equals yes}
        [do]
            {VARIABLE_OP rand_wound rand "1..100"}
            [switch]
                variable=rand_wound
                [case]
                    value=1,2,3
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                [has_attack]
                                    special_id=magical
                                [/has_attack]
                            [/filter]
                        [/have_location]
                        [then]
                            {NFW_concussion_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=4,5
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            terrain=A*,D*
                        [/have_location]
                        [then]
                            {NFW_fear_of_desert_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=F*,T*,*^F*,*^T*
                            [/have_location]
                            [not]
                                [have_location]
                                    {EVENT_UNIT}
                                    [filter]
                                        race=wose,elf
                                    [/filter]
                                [/have_location]
                            [/not]
                            [then]
                                {NFW_fear_of_plant_WOUND}
                                {VARIABLE rand_wound_selected yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=U*
                            [/have_location]
                            [then]
                                {NFW_fear_of_cave_WOUND}
                                {VARIABLE rand_wound_selected yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=M*,H*
                            [/have_location]
                            [then]
                                {NFW_fear_of_hight_WOUND}
                                {VARIABLE rand_wound_selected yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=W*,S*
                            [/have_location]
                            [then]
                                {NFW_fear_of_water_WOUND}
                                {VARIABLE rand_wound_selected yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=G*,R*
                                [not]
                                    terrain=*^V*,*^P*,*^E*,*^F*,*^T*,*^B*
                                [/not]
                                [not]
                                    time_of_day_id=indoors,underground,deep_underground
                                [/not]
                            [/have_location]
                            [then]
                                {NFW_fear_of_open_WOUND}
                                {VARIABLE rand_wound_selected yes}
                            [/then]
                        [/elseif]
                    [/if]
                [/case]
                [case]
                    value=6,7
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            terrain=W*,S*
                        [/have_location]
                        [then]
                            [if]
                                [have_location]
                                    {EVENT_UNIT}
                                    [filter]
                                        race=merman,naga
                                    [/filter]
                                [/have_location]
                                [or]
                                    {VARIABLE_CONDITIONAL nfwe_unit_type.undead_variation equals swimmer}
                                [/or]
                                [or]
                                    [have_location]
                                        {EVENT_UNIT}
                                        [filter]
                                            formula="movement_cost(self, 'Gg') > max_moves"
                                            [and]
                                                formula="movement_cost(self, 'Wo') = 1"
                                            [/and]
                                        [/filter]
                                    [/have_location]
                                [/or]
                                [else]
                                    {NFW_fear_of_water_WOUND}
                                    {VARIABLE rand_wound_selected yes}
                                [/else]
                            [/if]
                        [/then]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=A*,D*
                            [/have_location]
                            [then]
                                {NFW_fear_of_desert_WOUND}
                                {VARIABLE rand_wound_selected yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=U*
                            [/have_location]
                            [then]
                                {NFW_fear_of_cave_WOUND}
                                {VARIABLE rand_wound_selected yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=F*,T*,*^F*,*^T*
                            [/have_location]
                            [not]
                                [have_location]
                                    {EVENT_UNIT}
                                    [filter]
                                        race=wose
                                    [/filter]
                                [/have_location]
                            [/not]
                            [then]
                                {NFW_fear_of_plant_WOUND}
                                {VARIABLE rand_wound_selected yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=M*,H*
                            [/have_location]
                            [then]
                                {NFW_fear_of_hight_WOUND}
                                {VARIABLE rand_wound_selected yes}
                            [/then]
                        [/elseif]
                    [/if]
                [/case]
                [case]
                    value=8
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                ability=nfw_scared_of_dark
                            [/filter]
                        [/have_location]
                        [or]
                            [have_location]
                                {EVENT_UNIT}
                                [filter]
                                    ability=nfw_scared_of_light
                                [/filter]
                            [/have_location]
                        [/or]
                        [else]
                            [if]
                                [have_location]
                                    {EVENT_UNIT}
                                    time_of_day=chaotic
                                [/have_location]
                                [then]
                                    {NFW_fear_of_dark_WOUND}
                                    {VARIABLE rand_wound_selected yes}
                                [/then]
                                [elseif]
                                    [have_location]
                                        {EVENT_UNIT}
                                        time_of_day=lawful
                                    [/have_location]
                                    [then]
                                        {NFW_fear_of_light_WOUND}
                                        {VARIABLE rand_wound_selected yes}
                                    [/then]
                                [/elseif]
                            [/if]
                        [/else]
                    [/if]
                [/case]
                [case]
                    value=9,10
                    [if]
                        {VARIABLE_CONDITIONAL nfw_weapon_type equals ice}
                        [or]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=A*,Ms*,Ha*,Cea^*,Coa^*,Cha^*,Cva^*,Cfa^*,Kea^*,Koa^*,Kha^*,Kva^*,Kfa^*,Rra^*,*^Esa,*^Fpa,*^Feta,*^Fda,*^Fma,*^Voa,*^Vea,*^Vha,*^Vhca,*^Vhha,*^Vca,*^Vla,*^Vaa
                            [/have_location]
                        [/or]
                        [then]
                            {NFW_frostbite_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=11,12,13,14,82
                    [if]
                        {VARIABLE_CONDITIONAL nfw_weapon_type equals ice}
                        [or]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=A*,Ms*,Ha*,Cea^*,Coa^*,Cha^*,Cva^*,Cfa^*,Kea^*,Koa^*,Kha^*,Kva^*,Kfa^*,Rra^*,*^Esa,*^Fpa,*^Feta,*^Fda,*^Fma,*^Voa,*^Vea,*^Vha,*^Vhca,*^Vhha,*^Vca,*^Vla,*^Vaa
                            [/have_location]
                        [/or]
                        [not]
                            [have_location]
                                {EVENT_UNIT}
                                [filter]
                                    [has_attack]
                                        type=ice
                                    [/has_attack]
                                [/filter]
                            [/have_location]
                        [/not]
                        [then]
                            {NFW_frostbite_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=15,16
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                [has_attack]
                                    special_id=magical
                                [/has_attack]
                            [/filter]
                        [/have_location]
                        [and]
                            [not]
                                [have_location]
                                    {EVENT_UNIT}
                                    [filter]
                                        ability=wild_magic_display
                                    [/filter]
                                [/have_location]
                            [/not]
                        [/and]
                        [then]
                            {NFW_wild_magic_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=17,18,19,20,21,22,23,24,25
                    [if]
                        {VARIABLE_CONDITIONAL nfw_weapon_type equals fire}
                        [or]
                            [have_location]
                                {EVENT_UNIT}
                                terrain=*^Ecf,*^Eb,Ql*,Mv*,Yl*
                            [/have_location]
                        [/or]
                        [then]
                            {NFW_burned_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=26,27
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                race=horse,monster,wolf,bats,falcon,gryphon,bird,eoma_roc,eoma_magical
                                [or]
                                    type=SotA Soulless_Bat,SotA Flying Corpse_Bat,Wyrm,Cave Wyrmlet,Cave Wyrm,Red Wyrmlet,Red Wyrm
                                [/or]
                                [or]
                                    variation=bat,falcon,gryphon,bird,horse,rat,spider,serpent,boar,wolf
                                [/or]
                                [or]
                                    trait=magical
                                [/or]
                            [/filter]
                        [/have_location]
                        [or]
                            {VARIABLE_CONDITIONAL nfwe_unit_type.movement_type equals undeadspirit}
                        [/or]
                        [else]
                            {NFW_broken_arm_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/else]
                    [/if]
                [/case]
                [case]
                    value=28,29,30,83,84
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                race=bats,falcon,gryphon,drake,bird,eoma_roc
                                [or]
                                    type=SotA Soulless_Bat,SotA Flying Corpse_Bat,Wyrm,Cave Wyrmlet,Cave Wyrm,Red Wyrmlet,Red Wyrm
                                [/or]
                                [or]
                                    variation=bat,drake,falcon,gryphon,bird
                                [/or]
                                [not]
                                    type=Drake Clasher,Drake Thrasher,Drake Arbiter,Drake Enforcer,Drake Warden
                                [/not]
                            [/filter]
                        [/have_location]
                        [and]
                            [have_location]
                                {EVENT_UNIT}
                                [filter]
                                    formula="max_moves > 1"
                                [/filter]
                            [/have_location]
                        [/and]
                        [then]
                            {NFW_broken_wing_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=31,32
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                race=bats,falcon,gryphon,naga,merman,bird,eoma_roc,eoma_magical
                                [or]
                                    type=SotA Soulless_Bat,SotA Flying Corpse_Bat,Wyrm,Cave Wyrmlet,Cave Wyrm,Red Wyrmlet,Red Wyrm
                                [/or]
                                [or]
                                    variation=bat,drake,falcon,gryphon,swimmer,bird
                                [/or]
                                [or]
                                    trait=magical
                                [/or]
                            [/filter]
                        [/have_location]
                        [or]
                            [have_location]
                                {EVENT_UNIT}
                                [filter]
                                    formula="max_moves <= 1"
                                [/filter]
                            [/have_location]
                        [/or]
                        [or]
                            {VARIABLE_CONDITIONAL nfwe_unit_type.movement_type equals undeadspirit}
                        [/or]
                        [else]
                            {NFW_broken_leg_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/else]
                    [/if]
                [/case]
                [case]
                    value=33,34,35
                    [if]
                        {VARIABLE_CONDITIONAL nfw_weapon_type equals impact}
                        {VARIABLE_CONDITIONAL nfwe_unit_type.movement_type not_equals undeadspirit}
                        {VARIABLE_CONDITIONAL nfwe_unit_type.race not_equals eoma_magical}
                        [and]
                            [not]
                                [have_location]
                                    {EVENT_UNIT}
                                    [filter]
                                        trait=magical
                                    [/filter]
                                [/have_location]
                            [/not]
                        [/and]
                        [then]
                            {NFW_broken_rib_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=36
                    [if]
                        {VARIABLE_CONDITIONAL nfwe_unit_type.movement_type not_equals undeadspirit}
                        {VARIABLE_CONDITIONAL nfwe_unit_type.race not_equals eoma_magical}
                        [and]
                            [not]
                                [have_location]
                                    {EVENT_UNIT}
                                    [filter]
                                        trait=magical
                                    [/filter]
                                [/have_location]
                            [/not]
                        [/and]
                        [then]
                            {NFW_broken_rib_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=37,38,39,40
                    [if]
                        {VARIABLE_CONDITIONAL nfw_weapon_type equals blade}
                        [then]
                            {NFW_gash_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=41
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                [has_attack]
                                    special_type=berserk
                                [/has_attack]
                            [/filter]
                        [/have_location]
                        [or]
                            [not]
                                [have_location]
                                    {EVENT_UNIT}
                                    [filter]
                                        [has_attack]
                                            range=melee
                                        [/has_attack]
                                    [/filter]
                                [/have_location]
                            [/not]
                        [/or]
                        [else]
                            {NFW_insane_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/else]
                    [/if]
                [/case]
                [case]
                    value=42
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                status=unpoisonable
                            [/filter]
                        [/have_location]
                        [or]
                            [have_location]
                                {EVENT_UNIT}
                                [filter]
                                    ability=infection_display
                                [/filter]
                            [/have_location]
                        [/or]
                        [else]
                            {NFW_infection_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/else]
                    [/if]
                [/case]
                [case]
                    value=43
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                ability=amnesia_dummy
                            [/filter]
                        [/have_location]
                        [or]
                            [not]
                                [have_location]
                                    {EVENT_UNIT}
                                    [filter]
                                        [filter_wml]
                                            [advancement]
                                                glob_on_id=*
                                            [/advancement]
                                        [/filter_wml]
                                    [/filter]
                                [/have_location]
                            [/not]
                            [and]
                                {VARIABLE_CONDITIONAL unit.advances_to equals $nfw_empty_var}
                                [or]
                                    {VARIABLE_CONDITIONAL unit.advances_to equals ""}
                                [/or]
                            [/and]
                        [/or]
                        [else]
                            {NFW_amnesia_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/else]
                    [/if]
                [/case]
                [case]
                    value=44
#ifdef CAMPAIGN_NORTHERN_REBIRTH
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                id=Sister Thera,Father Morvin
                            [/filter]
                        [/have_location]
                        [else]
#endif
                            {NFW_captured_WOUND}
                            {VARIABLE rand_wound_selected yes}
#ifdef CAMPAIGN_NORTHERN_REBIRTH
                        [/else]
                    [/if]
#endif
                [/case]
                [case]
                    value=45
                    {NFW_Coward_WOUND}
                    {VARIABLE rand_wound_selected yes}
                [/case]
                [case]
                    value=46,47,48
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                ability=nfw_scared_of_weapon
                            [/filter]
                        [/have_location]
                        [or]
                            [variable]
                                name=nfw_scary_weapon
                                equals=$nfw_empty_var
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=nfw_scary_weapon_translated
                                equals=$nfw_empty_var
                            [/variable]
                        [/or]
                        [else]
                            {NFW_fear_of_weapon_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/else]
                    [/if]
                [/case]
                [case]
                    value=49,50
                    {NFW_maimed_WOUND}
                    {VARIABLE rand_wound_selected yes}
                [/case]
                [case]
                    value=51
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                ability=sick_display
                            [/filter]
                        [/have_location]
                        [else]
                            {NFW_sick_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/else]
                    [/if]
                [/case]
                [case]
                    value=52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                status=slowed
                            [/filter]
                        [/have_location]
                        [and]
                            [not]
                                [have_location]
                                    {EVENT_UNIT}
                                    [filter]
                                        ability=sick_display
                                    [/filter]
                                [/have_location]
                            [/not]
                        [/and]
                        [then]
                            {NFW_sick_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                        [elseif]
                            [have_location]
                                {EVENT_UNIT}
                                [filter]
                                    status=poisoned
                                [/filter]
                            [/have_location]
                            [and]
                                [not]
                                    [have_location]
                                        {EVENT_UNIT}
                                        [filter]
                                            ability=infection_display
                                        [/filter]
                                    [/have_location]
                                [/not]
                            [/and]
                            [then]
                                {NFW_infection_WOUND}
                                {VARIABLE rand_wound_selected yes}
                            [/then]
                        [/elseif]
                    [/if]
                [/case]
                [case]
                    value=85
                    {NFW_necrosis_WOUND}
                    {VARIABLE rand_wound_selected yes}
                [/case]
                [case]
                    value=86,87,88,89,90,91,92
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                formula="experience > (max_experience / 1.5)"
                            [/filter]
                        [/have_location]
                        [and]
                            [have_location]
                                {EVENT_UNIT}
                                [filter]
                                    [filter_wml]
                                        [advancement]
                                            glob_on_id=*
                                        [/advancement]
                                    [/filter_wml]
                                [/filter]
                            [/have_location]
                            [or]
                                {VARIABLE_CONDITIONAL unit.advances_to not_equals $nfw_empty_var}
                                [and]
                                    {VARIABLE_CONDITIONAL unit.advances_to not_equals ""}
                                [/and]
                            [/or]
                        [/and]
                        [then]
                            {NFW_short_term_memory_loss_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value==93,94,95,96
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                [filter_side]
                                    formula="fog"
                                [/filter_side]
                            [/filter]
                        [/have_location]
                        [then]
                            {NFW_fear_of_fog_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=97,98,99,100
                    [if]
                        [have_location]
                            {EVENT_UNIT}
                            [filter]
                                ability=nfw_scared_of_type
                            [/filter]
                        [/have_location]
                        [or]
                            [variable]
                                name=nfwe_second_unit_type
                                equals=$nfw_empty_var
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=nfwe_second_unit_type.name
                                equals=$nfw_empty_var
                            [/variable]
                        [/or]
                        [else]
                            {NFW_fear_of_type_WOUND}
                            {VARIABLE rand_wound_selected yes}
                        [/else]
                    [/if]
                [/case]
            [/switch]
        [/do]
    [/while]
    {CLEAR_VARIABLE rand_wound_selected}
[/event]

#ifdef LOTI_1_OR_2
[event]
    name=last_breath
    id=nfw_loti_amla_removed_die
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL nfw_loti_amla equals yes}
    [/filter_condition]
    [filter]
        [filter_wml]
            [advancement]
                glob_on_id=NFW_*
            [/advancement]
        [/filter_wml]
        [and]
            [filter_wml]
                [advancement]
                    id=backup_amla
                [/advancement]
            [/filter_wml]
        [/and]
    [/filter]
    [modify_unit]
        {FILTER_EVENT_UNIT}
        [object]
            id=nfw_loti_backup_amla
            [effect]
                apply_to=remove_advancement
                amlas=backup_amla
            [/effect]
        [/object]
        [set_variable]
            name=nfw_backup_amla
            value=yes
        [/set_variable]
    [/modify_unit]
[/event]
#endif
